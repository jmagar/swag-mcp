    # MCP Server endpoint for streamable-http transport
    location ^~ {{ mcp_path | default('/mcp') }} {
{% if auth_method != "none" %}
        # enable for {{ auth_method }} (requires {{ auth_method }}-server.conf in the server block)
        include /config/nginx/{{ auth_method }}-location.conf;
{% endif %}
        include /config/nginx/resolver.conf;

        set $upstream_app {{ upstream_app }};
        set $upstream_port {{ upstream_port }};
        set $upstream_proto {{ upstream_proto }};

        # Essential settings for MCP streamable-http transport
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        proxy_max_temp_file_size 0;
        chunked_transfer_encoding on;

        # Disable upstream compression for SSE streams
        proxy_set_header Accept-Encoding "";

        # Connection management for SSE/streaming
        proxy_set_header Connection "";

        # Response headers for streaming/caching control
        add_header X-Accel-Buffering "no" always;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        add_header Vary "Accept" always;
        add_header X-Request-Id $http_x_request_id always;
        # Standard reverse proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # MCP-specific headers
        proxy_set_header Accept $http_accept;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;
        proxy_set_header X-Request-Id $http_x_request_id;

        # Timeouts for persistent connections
        proxy_connect_timeout 60s;
        proxy_send_timeout 86400s;
        proxy_read_timeout 86400s;

{% if upstream_proto == "https" %}
        # SNI support for HTTPS upstream connections
        proxy_ssl_server_name on;
        proxy_ssl_name $upstream_app;
{% endif %}
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
