## Version 2025/08/20
# Generated by SWAG MCP Server
# MCP Streamable-HTTP Reverse Proxy Configuration
# Service: {{ service_name }}
# Domain: {{ server_name }}
# Upstream: {{ upstream_proto }}://{{ upstream_app }}:{{ upstream_port }}

server {
    listen 443 ssl;
{% if enable_quic %}
    listen 443 quic;
    add_header Alt-Svc 'h3=":443"; ma=86400, h3-29=":443"; ma=86400' always;
{% endif %}
    listen [::]:443 ssl;
{% if enable_quic %}
    listen [::]:443 quic;
    add_header Alt-Svc 'h3=":443"; ma=86400, h3-29=":443"; ma=86400' always;
{% endif %}

    server_name {{ server_name }};

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    # Security headers
    include /config/nginx/security-headers.conf;

    # Authelia disabled for OAuth - remove these lines:
    # include /config/nginx/authelia-server.conf;

    # Upstream target
    set $upstream_app "{{ upstream_app }}";
    set $upstream_port "{{ upstream_port }}";
    set $upstream_proto "{{ upstream_proto }}";

{% if auth_method != "none" %}
    # enable for {{ auth_method }} (requires {{ auth_method }}-location.conf in the location block)
    include /config/nginx/{{ auth_method }}-server.conf;
{% endif %}

    # Main MCP endpoint for streamable-http transport
    location /mcp {
        # Authelia disabled for OAuth - remove this line:
        # include /config/nginx/authelia-location.conf;
{% if auth_method != "none" %}
        # enable for {{ auth_method }} (requires {{ auth_method }}-server.conf in the server block)
        include /config/nginx/{{ auth_method }}-location.conf;
{% endif %}
        include /config/nginx/resolver.conf;

        # Essential settings for MCP streamable-http
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        proxy_max_temp_file_size 0;
        chunked_transfer_encoding on;

        # Connection management for SSE/streaming
        proxy_set_header Connection '';

        # Standard reverse proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # MCP-specific headers
        proxy_set_header Accept $http_accept;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;

        # Timeouts for persistent connections
        proxy_connect_timeout 60s;
        proxy_send_timeout 86400s;
        proxy_read_timeout 86400s;

        # Streaming cache control
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # OAuth discovery endpoints
    location = /.well-known/oauth-authorization-server {
        include /config/nginx/resolver.conf;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    location = /.well-known/openid-configuration {
        include /config/nginx/resolver.conf;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # OAuth endpoints (no Authelia here)
    location = /register {
        include /config/nginx/resolver.conf;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    location = /authorize {
        include /config/nginx/resolver.conf;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    location = /token {
        include /config/nginx/resolver.conf;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # No-cache headers for token endpoint
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    location = /revoke {
        include /config/nginx/resolver.conf;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # No-cache headers for revoke endpoint
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # Google â†’ server callback (and any /auth/* paths)
    location /auth/ {
        include /config/nginx/resolver.conf;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # Health check endpoint (no auth required)
    location /health {
        include /config/nginx/resolver.conf;

        # Disable buffering for health checks
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
}
