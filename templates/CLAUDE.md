# SWAG MCP Templates - Claude Memory Reference

This directory contains Jinja2 templates for generating nginx reverse proxy configurations with security, performance, and MCP-specific optimizations.

## Directory Purpose

The `templates/` directory provides secure Jinja2 templates for:
- Standard reverse proxy configurations (subdomain, subfolder)
- MCP-optimized configurations with SSE and streaming support
- Authentication integration (Authelia, Authentik, LDAP, TinyAuth)
- QUIC/HTTP3 support for modern performance
- Security headers and SSL/TLS optimization

## Template Files

### `subdomain.conf.j2` - Standard Subdomain Reverse Proxy
Basic reverse proxy template for subdomain-based services:

```nginx
# {{ service_name }} subdomain configuration
# Generated by SWAG MCP

server {
    listen 443 ssl{% if enable_quic %} quic reuseport{% endif %};
    listen [::]:443 ssl{% if enable_quic %} quic reuseport{% endif %};
    server_name {{ server_name }};

    # SSL configuration
    include /config/nginx/ssl.conf;
    {% if enable_quic %}
    # QUIC/HTTP3 headers
    add_header Alt-Svc 'h3-29=":443"; ma=86400';
    add_header Alt-Svc 'h3=":443"; ma=86400';
    {% endif %}

    # Security headers
    include /config/nginx/security-headers.conf;

    # Authentication
    {% if auth_method != "none" %}
    include /config/nginx/{{ auth_method }}.conf;
    {% endif %}

    # Main location
    location / {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        # Upstream configuration
        set $upstream_app {{ upstream_app }};
        set $upstream_port {{ upstream_port }};
        set $upstream_proto {{ upstream_proto }};
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
}
```

### `subfolder.conf.j2` - Path-Based Routing Template
Template for subfolder/path-based service access:

```nginx
# {{ service_name }} subfolder configuration
# Generated by SWAG MCP

location ^~ /{{ service_name }}/ {
    return 301 $scheme://$host/{{ service_name }};
}

location ^~ /{{ service_name }} {
    # Authentication
    {% if auth_method != "none" %}
    include /config/nginx/{{ auth_method }}.conf;
    {% endif %}

    # Proxy configuration
    include /config/nginx/proxy.conf;
    include /config/nginx/resolver.conf;

    # Upstream configuration
    set $upstream_app {{ upstream_app }};
    set $upstream_port {{ upstream_port }};
    set $upstream_proto {{ upstream_proto }};
    proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    # Path rewriting for subfolders
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
}
```

### `mcp-subdomain.conf.j2` - MCP-Optimized Subdomain Template
Specialized template for MCP services with streaming and SSE optimizations:

```nginx
# {{ service_name }} MCP subdomain configuration
# Generated by SWAG MCP - Optimized for streaming and SSE

server {
    listen 443 ssl{% if enable_quic %} quic reuseport{% endif %};
    listen [::]:443 ssl{% if enable_quic %} quic reuseport{% endif %};
    server_name {{ server_name }};

    # SSL configuration
    include /config/nginx/ssl.conf;
    {% if enable_quic %}
    # QUIC/HTTP3 support
    add_header Alt-Svc 'h3-29=":443"; ma=86400';
    add_header Alt-Svc 'h3=":443"; ma=86400';
    {% endif %}

    # Security headers (modified for streaming)
    include /config/nginx/security-headers.conf;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;

    # Authentication
    {% if auth_method != "none" %}
    include /config/nginx/{{ auth_method }}.conf;
    {% endif %}

    # MCP streaming endpoint
    location / {
        # Disable buffering for real-time streaming
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;

        # Extended timeouts for long-running MCP operations
        proxy_connect_timeout 60s;
        proxy_send_timeout 24h;
        proxy_read_timeout 24h;

        # SSE/streaming headers
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        proxy_set_header Cache-Control 'no-cache, no-store, must-revalidate';
        proxy_set_header Pragma 'no-cache';
        proxy_set_header Expires '0';

        # Standard proxy configuration
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        # Upstream configuration
        set $upstream_app {{ upstream_app }};
        set $upstream_port {{ upstream_port }};
        set $upstream_proto {{ upstream_proto }};
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

        # Enable chunked transfer encoding
        chunked_transfer_encoding on;
    }

    # Health check endpoint (bypasses auth for monitoring)
    location /health {
        proxy_buffering off;
        proxy_pass {{ upstream_proto }}://{{ upstream_app }}:{{ upstream_port }}/health;
        access_log off;
    }
}
```

### `mcp-subfolder.conf.j2` - MCP-Optimized Subfolder Template
Path-based MCP configuration with streaming support:

```nginx
# {{ service_name }} MCP subfolder configuration
# Generated by SWAG MCP - Optimized for streaming and SSE

location ^~ /{{ service_name }}/ {
    return 301 $scheme://$host/{{ service_name }};
}

location ^~ /{{ service_name }} {
    # Authentication
    {% if auth_method != "none" %}
    include /config/nginx/{{ auth_method }}.conf;
    {% endif %}

    # MCP streaming optimizations
    proxy_buffering off;
    proxy_cache off;
    proxy_request_buffering off;

    # Extended timeouts for MCP operations
    proxy_connect_timeout 60s;
    proxy_send_timeout 24h;
    proxy_read_timeout 24h;

    # SSE/streaming headers
    proxy_set_header Connection '';
    proxy_http_version 1.1;
    proxy_set_header Cache-Control 'no-cache, no-store, must-revalidate';

    # Standard proxy headers
    include /config/nginx/proxy.conf;
    include /config/nginx/resolver.conf;

    # Path-specific headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # Upstream configuration
    set $upstream_app {{ upstream_app }};
    set $upstream_port {{ upstream_port }};
    set $upstream_proto {{ upstream_proto }};
    proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    # Enable chunked encoding
    chunked_transfer_encoding on;
}

# Health check for subfolder MCP services
location ^~ /{{ service_name }}/health {
    proxy_buffering off;
    proxy_pass {{ upstream_proto }}://{{ upstream_app }}:{{ upstream_port }}/health;
    access_log off;
}
```

## Template Variables

### Required Variables
All templates accept these core variables:

```python
template_vars = {
    'service_name': 'jellyfin',           # Service identifier
    'server_name': 'media.example.com',  # Domain name
    'upstream_app': 'jellyfin',          # Container/host name
    'upstream_port': 8096,               # Port number
    'upstream_proto': 'http',            # http or https
    'auth_method': 'authelia',           # Authentication method
    'enable_quic': False                 # QUIC/HTTP3 support
}
```

### Authentication Methods
Supported authentication integrations:

- **`none`**: No authentication (open access)
- **`authelia`**: Authelia authentication middleware
- **`authentik`**: Authentik authentication proxy
- **`ldap`**: LDAP authentication
- **`tinyauth`**: TinyAuth lightweight authentication

### Configuration Types
Template selection based on `config_type`:

- **`subdomain`**: Uses `subdomain.conf.j2` for `service.example.com`
- **`subfolder`**: Uses `subfolder.conf.j2` for `example.com/service`
- **`mcp-subdomain`**: Uses `mcp-subdomain.conf.j2` with streaming optimizations
- **`mcp-subfolder`**: Uses `mcp-subfolder.conf.j2` with streaming optimizations

## Security Features

### Template Sandboxing
Templates run in a secure Jinja2 environment:

```python
# Sandboxed environment configuration
env = Environment(
    loader=FileSystemLoader(template_path),
    autoescape=True,  # Prevent XSS
    undefined=StrictUndefined  # Fail on undefined variables
)

# Remove dangerous functions
env.globals.pop('range', None)
env.globals.pop('dict', None)
env.globals.pop('list', None)

# Restrict access to filesystem and imports
env.overlay({'__builtins__': {}})
```

### SSTI Prevention
Server-Side Template Injection (SSTI) protection:

- **Input validation**: All variables validated before templating
- **Character whitelist**: Service names use alphanumeric + dash/underscore only
- **No user-controlled template paths**: Template selection hardcoded
- **Sandboxed execution**: No access to Python builtins or filesystem

### Security Headers
All templates include comprehensive security headers:

```nginx
# Security headers included in all templates
add_header X-Content-Type-Options nosniff always;
add_header X-Frame-Options SAMEORIGIN always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
```

## MCP Optimizations

### Streaming Configuration
MCP templates optimize for real-time streaming:

```nginx
# Zero-buffering configuration
proxy_buffering off;
proxy_cache off;
proxy_request_buffering off;

# Chunked transfer encoding
chunked_transfer_encoding on;

# SSE-friendly headers
proxy_set_header Connection '';
proxy_http_version 1.1;
proxy_set_header Cache-Control 'no-cache';
```

### Extended Timeouts
Long-running MCP operations supported:

```nginx
# Extended timeouts for MCP operations
proxy_connect_timeout 60s;
proxy_send_timeout 24h;    # Long-running AI operations
proxy_read_timeout 24h;    # Streaming responses
```

### Health Check Bypass
Health checks bypass authentication for monitoring:

```nginx
location /health {
    proxy_pass http://upstream:port/health;
    access_log off;  # Reduce log noise
}
```

## Performance Features

### QUIC/HTTP3 Support
Modern protocol support when enabled:

```nginx
{% if enable_quic %}
listen 443 ssl quic reuseport;
add_header Alt-Svc 'h3-29=":443"; ma=86400';
add_header Alt-Svc 'h3=":443"; ma=86400';
{% endif %}
```

### Connection Optimization
Efficient connection handling:

```nginx
# HTTP/1.1 with keep-alive
proxy_http_version 1.1;
proxy_set_header Connection '';

# DNS resolver configuration
include /config/nginx/resolver.conf;

# Connection reuse
upstream {{ service_name }}_backend {
    server {{ upstream_app }}:{{ upstream_port }};
    keepalive 32;
}
```

## Template Usage Patterns

### Template Rendering in Code
```python
from jinja2 import Environment, FileSystemLoader

# Setup secure template environment
env = Environment(
    loader=FileSystemLoader('templates'),
    autoescape=True,
    undefined=StrictUndefined
)

# Render template with variables
template = env.get_template('subdomain.conf.j2')
config_content = template.render(
    service_name='jellyfin',
    server_name='media.example.com',
    upstream_app='jellyfin',
    upstream_port=8096,
    upstream_proto='http',
    auth_method='authelia',
    enable_quic=False
)
```

### Template Selection Logic
```python
def get_template_name(config_type: str) -> str:
    """Get template filename for configuration type"""
    template_map = {
        'subdomain': 'subdomain.conf.j2',
        'subfolder': 'subfolder.conf.j2',
        'mcp-subdomain': 'mcp-subdomain.conf.j2',
        'mcp-subfolder': 'mcp-subfolder.conf.j2'
    }

    if config_type not in template_map:
        raise ValueError(f"Invalid config type: {config_type}")

    return template_map[config_type]
```

## Development Commands

### Template Testing
```bash
# Test template rendering
python -c "
from jinja2 import Environment, FileSystemLoader
env = Environment(loader=FileSystemLoader('templates'))
template = env.get_template('subdomain.conf.j2')
print(template.render(
    service_name='test',
    server_name='test.example.com',
    upstream_app='test-app',
    upstream_port=8080,
    upstream_proto='http',
    auth_method='none',
    enable_quic=False
))
"

# Validate nginx syntax
nginx -t -c /path/to/generated/config.conf

# Test template security
uv run pytest tests/test_templates.py::TestTemplateSecurity -v
```

### Template Validation
```bash
# Check for template syntax errors
python -c "
from jinja2 import Environment, FileSystemLoader, meta
env = Environment(loader=FileSystemLoader('templates'))
for template_name in ['subdomain.conf.j2', 'mcp-subdomain.conf.j2']:
    template = env.get_template(template_name)
    print(f'{template_name}: Variables - {meta.find_undeclared_variables(template.new_context().environment, template.new_context().globals)}')
"
```

## Important Notes

### Template Security
- **Input validation**: All variables validated before rendering
- **Sandboxed environment**: No access to dangerous Python functions
- **Path restrictions**: Template paths hardcoded, not user-controlled
- **XSS prevention**: Automatic HTML escaping enabled

### MCP-Specific Features
- **Zero buffering**: Enables real-time streaming
- **Extended timeouts**: Supports long-running AI operations
- **SSE optimization**: Headers configured for server-sent events
- **Health checks**: Monitoring endpoints bypass authentication

### Performance Considerations
- **Template caching**: Jinja2 templates compiled once and cached
- **Connection reuse**: HTTP/1.1 keep-alive for efficiency
- **QUIC support**: Modern HTTP/3 for improved performance
- **DNS caching**: Resolver configuration reduces lookup overhead

### Authentication Integration
- **Modular design**: Authentication includes optional per method
- **Bypass patterns**: Health checks and monitoring exclude auth
- **Security first**: Default to secure authentication methods
- **Flexible configuration**: Supports multiple authentication providers

### Common Issues
- **Template path**: Must be relative to working directory
- **Variable validation**: Undefined variables cause template errors
- **Nginx syntax**: Generated configs must pass `nginx -t` validation
- **File permissions**: Generated configs need proper read permissions
