## Version 2025/09/29 - MCP 2025-06-18 SWAG Compatible
# Generated by SWAG MCP Server
# MCP Streamable-HTTP Reverse Proxy Configuration - SWAG OPTIMIZED
# Service: {{ service_name }}
# Path: /{{ service_name }}
# Upstream: {{ upstream_proto }}://{{ upstream_app }}:{{ upstream_port }}
# MCP Compliance: 2025-06-18 Full Specification Support (SWAG Compatible)

# Define upstream variables at file scope so they're available to all location blocks
set $upstream_app "{{ upstream_app }}";
set $upstream_port "{{ upstream_port }}";
set $upstream_proto "{{ upstream_proto }}";
set $mcp_upstream_app "{{ mcp_upstream_app }}";
set $mcp_upstream_port "{{ mcp_upstream_port }}";
set $mcp_upstream_proto "{{ mcp_upstream_proto }}";

# Trailing slash redirect for /{{ service_name }}/
location ^~ /{{ service_name }}/ {
    return 301 $scheme://$host/{{ service_name }};
}

# Main service location block
location ^~ /{{ service_name }} {

    # MCP 2025-06-18 Compliance: DNS Rebinding Protection (Simplified)
    set $origin_valid 0;
    # Allow empty origin (server-to-server)
    if ($http_origin = "") {
        set $origin_valid 1;
    }
    # Allow same origin
    if ($http_origin = "https://$server_name") {
        set $origin_valid 1;
    }
    # Allow localhost for development
    if ($http_origin ~ "^https://(localhost|127\.0\.0\.1)(:[0-9]+)?$") {
        set $origin_valid 1;
    }

    # MCP 2025-06-18 Security Headers (avoiding ssl.conf conflicts)
    add_header X-MCP-Version "2025-06-18" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

{% if auth_method != "none" %}
    # Authentication for {{ auth_method }}
    include /config/nginx/{{ auth_method }}-location.conf;
{% endif %}

    # Resolver for DNS lookups
    include /config/nginx/resolver.conf;

    # MCP 2025-06-18: Essential settings for streamable-http transport
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_cache off;
    proxy_request_buffering off;
    proxy_max_temp_file_size 0;
    chunked_transfer_encoding on;

    # MCP-specific connection management for SSE/streaming (CANNOT use proxy.conf)
    proxy_set_header Connection '';

    # Standard reverse proxy headers (manual setup for MCP)
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # MCP 2025-06-18: REQUIRED protocol and session headers
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;
    proxy_set_header Accept $http_accept;

    # MCP timeouts (use SWAG proxy.conf values but specified explicitly)
    proxy_connect_timeout 240s;
    proxy_send_timeout 86400s;
    proxy_read_timeout 86400s;

    # Streaming cache control for real-time data
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;

    # CORS headers for web clients
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, MCP-Protocol-Version, Mcp-Session-Id, Last-Event-ID" always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Max-Age "3600" always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Content-Type "text/plain charset=UTF-8";
        add_header Content-Length 0;
        return 204;
    }

    proxy_pass $upstream_proto://$upstream_app:$upstream_port;
}

# Main MCP endpoint for streamable-http transport - SWAG COMPATIBLE
location ^~ /{{ service_name }}/mcp {
    # Origin validation for MCP endpoints (DNS rebinding protection)
    set $origin_valid 0;
    # Allow empty origin (server-to-server)
    if ($http_origin = "") {
        set $origin_valid 1;
    }
    # Allow same origin
    if ($http_origin = "https://$server_name") {
        set $origin_valid 1;
    }
    # Allow localhost for development
    if ($http_origin ~ "^https://(localhost|127\.0\.0\.1)(:[0-9]+)?$") {
        set $origin_valid 1;
    }

    if ($origin_valid = 0) {
        add_header Content-Type "application/json" always;
        return 403 '{"error": "origin_not_allowed", "message": "Origin header validation failed"}';
    }

    # MCP Protocol version validation (nginx-only, no Lua required)
    if ($http_mcp_protocol_version ~ "^.+$") {
        set $protocol_check 0;
        if ($http_mcp_protocol_version ~ "^(2025-06-18|2024-11-05|2025-03-26)$") {
            set $protocol_check 1;
        }
        if ($protocol_check = 0) {
            add_header Content-Type "application/json" always;
            return 400 '{"error": "unsupported_protocol_version", "message": "MCP protocol version not supported", "supported_versions": ["2025-06-18", "2024-11-05", "2025-03-26"]}';
        }
    }

{% if auth_method != "none" %}
    # Authentication for {{ auth_method }}
    include /config/nginx/{{ auth_method }}-location.conf;
{% endif %}

    # Resolver for DNS lookups
    include /config/nginx/resolver.conf;

    # MCP 2025-06-18: Essential settings for streamable-http transport
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_cache off;
    proxy_request_buffering off;
    proxy_max_temp_file_size 0;
    chunked_transfer_encoding on;

    # MCP-specific connection management for SSE/streaming (CANNOT use proxy.conf)
    proxy_set_header Connection '';

    # Standard reverse proxy headers (manual setup for MCP)
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Subfolder-specific path rewriting headers for MCP endpoint
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # MCP 2025-06-18: REQUIRED protocol and session headers
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;
    proxy_set_header Accept $http_accept;

    # MCP timeouts (use SWAG proxy.conf values but specified explicitly)
    proxy_connect_timeout 240s;
    proxy_send_timeout 86400s;
    proxy_read_timeout 86400s;

    # Streaming cache control for real-time data
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;

    # CORS headers for web clients
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, MCP-Protocol-Version, Mcp-Session-Id, Last-Event-ID" always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Max-Age "3600" always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Content-Type "text/plain charset=UTF-8";
        add_header Content-Length 0;
        return 204;
    }

    # Route to MCP service (may be different from main service)
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/mcp;
}

# MCP 2025-06-18 REQUIRED: OAuth 2.0 Protected Resource Metadata (RFC9728)
location ^~ /{{ service_name }}/.well-known/oauth-protected-resource {
    # Origin validation
    set $origin_valid 0;
    # Allow empty origin (server-to-server)
    if ($http_origin = "") {
        set $origin_valid 1;
    }
    # Allow same origin
    if ($http_origin = "https://$server_name") {
        set $origin_valid 1;
    }
    # Allow localhost for development
    if ($http_origin ~ "^https://(localhost|127\.0\.0\.1)(:[0-9]+)?$") {
        set $origin_valid 1;
    }

    if ($origin_valid = 0) {
        return 403 '{"error": "origin_not_allowed"}';
    }

    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # MCP protocol headers for metadata requests (added to proxy.conf headers)
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # Metadata should be cacheable but not for too long
    add_header Cache-Control "public, max-age=3600" always;

    # Route to MCP service
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/.well-known/oauth-protected-resource;
}

# OAuth 2.0 Authorization Server Metadata (RFC8414)
location ^~ /{{ service_name }}/.well-known/oauth-authorization-server {
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # Metadata should be cacheable
    add_header Cache-Control "public, max-age=3600" always;

    # Route to MCP service
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/.well-known/oauth-authorization-server;
}

# OpenID Connect Discovery (for compatibility)
location ^~ /{{ service_name }}/.well-known/openid-configuration {
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # Metadata should be cacheable
    add_header Cache-Control "public, max-age=3600" always;

    # Route to MCP service
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/.well-known/openid-configuration;
}

# OAuth 2.0 Dynamic Client Registration (RFC7591) - RECOMMENDED
location ^~ /{{ service_name }}/register {
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # Session and protocol headers
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # No caching for registration requests
    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;

    # Route to MCP service
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/register;
}

# OAuth 2.1 Authorization Endpoint
location ^~ /{{ service_name }}/authorize {
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # Session and protocol headers
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # Route to MCP service
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/authorize;
}

# OAuth 2.1 Token Endpoint
location ^~ /{{ service_name }}/token {
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # Session and protocol headers
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # No-cache headers for token endpoint (security)
    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;

    # Route to MCP service
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/token;
}

# OAuth 2.1 Token Revocation Endpoint
location ^~ /{{ service_name }}/revoke {
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # Session and protocol headers
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # No-cache headers for revoke endpoint (security)
    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;

    # Route to MCP service
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/revoke;
}

# OAuth callback handling (includes all /auth/* paths for various providers)
location ^~ /{{ service_name }}/auth/ {
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # Session and protocol headers
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # Route to MCP service
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port/auth/;
}

# Enhanced health check endpoint
location ^~ /{{ service_name }}/health {
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # MCP-specific health check configuration
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_cache off;
    proxy_request_buffering off;

    # MCP headers for health checks
    proxy_set_header Accept "application/json";
    proxy_set_header X-Health-Check "nginx-mcp-proxy";
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # Health checks should be fast (override proxy.conf timeouts)
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;

    # Health status should not be cached
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;

    # Route to main service (health checks the primary app)
    proxy_pass $upstream_proto://$upstream_app:$upstream_port/health;
}

# Session management endpoints (optional)
location ~* ^/{{ service_name }}/(session|sessions) {
{% if auth_method != "none" %}
    include /config/nginx/{{ auth_method }}-location.conf;
{% endif %}
    include /config/nginx/resolver.conf;
    include /config/nginx/proxy.conf;

    # Session endpoints require authentication
    proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;

    # Subfolder-specific path rewriting headers
    proxy_set_header X-Forwarded-Prefix /{{ service_name }};
    proxy_set_header X-Script-Name /{{ service_name }};

    # Sessions should never be cached
    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;

    # Route to MCP service (sessions are MCP-related)
    proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
}