## Version 2025/08/20 - MCP 2025-06-18 SWAG Compatible
# Generated by SWAG MCP Server
# MCP Streamable-HTTP Reverse Proxy Configuration - SWAG OPTIMIZED
# Service: {{ service_name }}
# Domain: {{ server_name }}
# Upstream: {{ upstream_proto }}://{{ upstream_app }}:{{ upstream_port }}
# MCP Compliance: 2025-06-18 Full Specification Support (SWAG Compatible)

server {
    listen 443 ssl;
{% if enable_quic %}
    listen 443 quic reuseport;
    add_header Alt-Svc 'h3=":443"; ma=86400, h3-29=":443"; ma=86400' always;
{% endif %}
    listen [::]:443 ssl;
{% if enable_quic %}
    listen [::]:443 quic reuseport;
    add_header Alt-Svc 'h3=":443"; ma=86400, h3-29=":443"; ma=86400' always;
{% endif %}

    server_name {{ server_name }};

    # SWAG Standard SSL Configuration
    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    # Main service upstream variables (SWAG standard pattern)
    set $upstream_app "{{ upstream_app }}";
    set $upstream_port "{{ upstream_port }}";
    set $upstream_proto "{{ upstream_proto }}";

    # MCP service upstream variables (may differ from main service)
    set $mcp_upstream_app "{{ mcp_upstream_app }}";
    set $mcp_upstream_port "{{ mcp_upstream_port }}";
    set $mcp_upstream_proto "{{ mcp_upstream_proto }}";

    # MCP 2025-06-18 Compliance: DNS Rebinding Protection (Simplified)
    set $origin_valid 0;
    # Allow empty origin (server-to-server)
    if ($http_origin = "") {
        set $origin_valid 1;
    }
    # Allow same origin
    if ($http_origin = "https://$server_name") {
        set $origin_valid 1;
    }
    # Allow localhost for development
    if ($http_origin ~ "^https://(localhost|127\.0\.0\.1)(:[0-9]+)?$") {
        set $origin_valid 1;
    }

    # MCP 2025-06-18 Security Headers (avoiding ssl.conf conflicts)
    add_header X-MCP-Version "2025-06-18" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

{% if auth_method != "none" %}
    # Authentication for {{ auth_method }} (SWAG standard pattern)
    include /config/nginx/{{ auth_method }}-server.conf;
{% endif %}

    # Main MCP endpoint for streamable-http transport - SWAG COMPATIBLE
    location /mcp {
        # Origin validation for MCP endpoints (DNS rebinding protection)
        if ($origin_valid = 0) {
            add_header Content-Type "application/json" always;
            return 403 '{"error": "origin_not_allowed", "message": "Origin header validation failed"}';
        }

        # MCP Protocol version validation (nginx-only, no Lua required) - flattened for nginx compatibility
        set $protocol_check 1;
        if ($http_mcp_protocol_version ~ "^.+$") {
            set $protocol_check 0;
        }
        if ($http_mcp_protocol_version ~ "^(2025-06-18|2024-11-05|2025-03-26)$") {
            set $protocol_check 1;
        }
        if ($protocol_check = 0) {
            add_header Content-Type "application/json" always;
            return 400 '{"error": "unsupported_protocol_version", "message": "MCP protocol version not supported", "supported_versions": ["2025-06-18", "2024-11-05", "2025-03-26"]}';
        }

{% if auth_method != "none" %}
        # Authentication for {{ auth_method }}
        include /config/nginx/{{ auth_method }}-location.conf;
{% endif %}

        # Resolver for DNS lookups
        include /config/nginx/resolver.conf;

        # MCP common configuration (buffering, headers, http version)
        include /config/nginx/mcp.conf;

        # MCP 2025-06-18: Additional streaming settings
        proxy_max_temp_file_size 0;
        chunked_transfer_encoding on;

        # MCP-specific connection management for SSE/streaming
        proxy_set_header Connection '';

        # MCP 2025-06-18: REQUIRED protocol and session headers
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;
        proxy_set_header Accept $http_accept;

        # MCP timeouts (use SWAG proxy.conf values but specified explicitly)
        proxy_connect_timeout 240s;
        proxy_send_timeout 86400s;
        proxy_read_timeout 86400s;

        # Streaming cache control for real-time data
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # CORS headers for web clients
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, MCP-Protocol-Version, Mcp-Session-Id, Last-Event-ID" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Max-Age "3600" always;

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Content-Type "text/plain charset=UTF-8";
            add_header Content-Length 0;
            return 204;
        }

        # Route to MCP service (may be different from main service)
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # MCP 2025-06-18 REQUIRED: OAuth 2.0 Protected Resource Metadata (RFC9728)
    location = /.well-known/oauth-protected-resource {
        # Origin validation
        if ($origin_valid = 0) {
            return 403 '{"error": "origin_not_allowed"}';
        }

        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # MCP protocol headers for metadata requests (added to proxy.conf headers)
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;

        # Metadata should be cacheable but not for too long
        add_header Cache-Control "public, max-age=3600" always;

        # Route to MCP service
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # OAuth 2.0 Authorization Server Metadata (RFC8414)
    location = /.well-known/oauth-authorization-server {
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Metadata should be cacheable
        add_header Cache-Control "public, max-age=3600" always;

        # Route to MCP service
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # OpenID Connect Discovery (for compatibility)
    location = /.well-known/openid-configuration {
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Metadata should be cacheable
        add_header Cache-Control "public, max-age=3600" always;

        # Route to MCP service
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # OAuth 2.0 Dynamic Client Registration (RFC7591) - RECOMMENDED
    location = /register {
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Session and protocol headers
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;

        # No caching for registration requests
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;

        # Route to MCP service
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # OAuth 2.1 Authorization Endpoint
    location = /authorize {
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Session and protocol headers
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;

        # Route to MCP service
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # OAuth 2.1 Token Endpoint
    location = /token {
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Session and protocol headers
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;

        # No-cache headers for token endpoint (security)
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # Route to MCP service
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # OAuth 2.1 Token Revocation Endpoint
    location = /revoke {
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Session and protocol headers
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;

        # No-cache headers for revoke endpoint (security)
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # Route to MCP service
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # OAuth callback handling (includes all /auth/* paths for various providers)
    location /auth/ {
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Session and protocol headers
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;

        # Route to MCP service
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # Enhanced health check endpoint
    location /health {
        include /config/nginx/resolver.conf;
        include /config/nginx/mcp.conf;

        # MCP headers for health checks
        proxy_set_header Accept "application/json";
        proxy_set_header X-Health-Check "nginx-mcp-proxy";
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;

        # Health checks should be fast (override defaults)
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        # Health status should not be cached
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # Session management endpoints (optional)
    location ~* ^/(session|sessions) {
{% if auth_method != "none" %}
        include /config/nginx/{{ auth_method }}-location.conf;
{% endif %}
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Session endpoints require authentication
        proxy_set_header MCP-Protocol-Version $http_mcp_protocol_version;
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;

        # Sessions should never be cached
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;

        # Route to MCP service (sessions are MCP-related)
        proxy_pass $mcp_upstream_proto://$mcp_upstream_app:$mcp_upstream_port;
    }

    # Default location for normal web service (non-MCP traffic)
    location / {
{% if auth_method != "none" %}
        include /config/nginx/{{ auth_method }}-location.conf;
{% endif %}
        include /config/nginx/resolver.conf;
        include /config/nginx/proxy.conf;

        # Standard web service configuration (proxy.conf provides standard headers and WebSocket support)

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # Enhanced error pages with proper JSON responses
    error_page 400 @error_400;
    error_page 401 @error_401;
    error_page 403 @error_403;

    location @error_400 {
        internal;
        add_header Content-Type "application/json" always;
        return 400 '{"error": "bad_request", "message": "Invalid request format or missing required headers"}';
    }

    location @error_401 {
        internal;
        add_header Content-Type "application/json" always;
        add_header WWW-Authenticate 'Bearer realm="MCP Server", resource="https://$server_name/.well-known/oauth-protected-resource"' always;
        return 401 '{"error": "unauthorized", "message": "Valid authorization token required", "authorization_server": "https://$server_name/.well-known/oauth-authorization-server"}';
    }

    location @error_403 {
        internal;
        add_header Content-Type "application/json" always;
        return 403 '{"error": "forbidden", "message": "Insufficient permissions or origin not allowed"}';
    }
}